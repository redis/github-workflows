name: Early Access Release

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        default: '17'
        required: false
        type: string
      gradle-build-tasks:
        description: 'Gradle tasks to run before JReleaser (e.g., "build :app:bootJar :app:distTar :app:distZip")'
        default: 'build'
        required: false
        type: string
      jreleaser-version:
        description: 'JReleaser version to use'
        default: 'latest'
        required: false
        type: string
      runs-on:
        description: 'Runner to use for the release job'
        default: 'ubuntu-latest'
        required: false
        type: string
      skip-tests:
        description: 'Skip tests during build (adds -x test flag to Gradle)'
        default: false
        required: false
        type: boolean
    secrets:
      git-access-token:
        description: 'GitHub token with write access'
        required: true
      gpg-passphrase:
        description: 'GPG passphrase for signing'
        required: true
      gpg-public-key:
        description: 'GPG public key'
        required: true
      gpg-secret-key:
        description: 'GPG secret key'
        required: true
      slack-webhook:
        description: 'Slack webhook URL for notifications'
        required: false
      docker-username:
        description: 'Docker registry username (for bootBuildImage)'
        required: false
      docker-password:
        description: 'Docker registry password (for bootBuildImage)'
        required: false

jobs:
  early-access:
    runs-on: ${{ inputs.runs-on }}
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.git-access-token }}

      - name: Setup Gradle
        uses: redis/github-workflows/.github/actions/setup-gradle@main
        with:
          java-version: ${{ inputs.java-version }}

      - name: Get Snapshot Version
        id: version
        run: |
          VERSION=$(./gradlew currentVersion -q | grep "Project version:" | awk '{print $3}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Snapshot version: $VERSION"

      - name: Build
        env:
          DOCKER_USERNAME: ${{ secrets.docker-username }}
          DOCKER_PASSWORD: ${{ secrets.docker-password }}
        run: ./gradlew ${{ inputs.gradle-build-tasks }} ${{ inputs.skip-tests && '-x test' || '' }}

      - name: Release with JReleaser
        uses: redis/github-workflows/.github/actions/jreleaser@main
        with:
          version: ${{ steps.version.outputs.version }}
          git-access-token: ${{ secrets.git-access-token }}
          gpg-secret-key: ${{ secrets.gpg-secret-key }}
          gpg-public-key: ${{ secrets.gpg-public-key }}
          gpg-passphrase: ${{ secrets.gpg-passphrase }}
          slack-webhook: ${{ secrets.slack-webhook }}
          docker-username: ${{ secrets.docker-username }}
          docker-password: ${{ secrets.docker-password }}
          jreleaser-version: ${{ inputs.jreleaser-version }}
